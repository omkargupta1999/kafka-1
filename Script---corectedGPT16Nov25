#!/bin/bash
# ------------------------------------------------------------------
# Script: startup-multiple-namespaces.sh
# Purpose: Bring up selected applications (scale to desired replica count)
# Author: Omkar Gupta
# ------------------------------------------------------------------

# ====== CONFIGURATION ======
NAMESPACES=(
  "prod-dc-admin"
  "prod-dc-frontend"
  "prod-dc-kms"
  "prod-dc-simulators"
  "prod-dc-transaction"
  "prod-dc-merchant"
  "prod-dc-notification"
  "prod-dc-rns"
)

CUSTOM_DEPLOYMENTS=(
  "prod-dc-admin:admin-adminservice"
  "prod-dc-frontend:transactionfe-transaction-frontend,merchantfe-merchant-frontend"
  "prod-dc-kms:kms-kmsservice"
  "prod-dc-simulators:demo-merchantsimulator,javasimulator-javautilityapisimulator,orderhash"
  "prod-dc-transaction:payment-paymentservice,txn-transactionservice"
  "prod-dc-merchant:merchant-merchantservice,report-reportservice"
  "prod-dc-notification:notify-notificationservice"
  "prod-dc-rns:ops-operationsservice,refund-refundservice"
)

SCALE_TO=1
TARGETS="deployments"
OC_BIN="oc"

# --- START DATE/TIME SECTION ---
START_TIME=$(date +"%Y-%m-%d %H:%M:%S")
echo "==========================================="
echo " Script started on: $START_TIME"
echo "==========================================="
# --------------------------------

echo "==========================================="
echo " Application Startup Script (No Prompt Mode)"
echo "==========================================="

for ns in "${NAMESPACES[@]}"; do
  echo ""
  echo ">>> Processing namespace: $ns"

  # Switch to project
  $OC_BIN project "$ns" >/dev/null 2>&1
  if [ $? -ne 0 ]; then
    echo "âš ï¸  Failed to switch to namespace $ns. Skipping..."
    continue
  fi

  custom_entry=$(printf "%s\n" "${CUSTOM_DEPLOYMENTS[@]}" | grep "^$ns:" || true)
  deployments_list=$(echo "$custom_entry" | cut -d':' -f2 | tr ',' ' ')

  for target in $TARGETS; do
    echo "â†’ Scaling up $target in namespace $ns ..."
    for d in $deployments_list; do
      if [ -n "$d" ]; then
        echo "   - Scaling up $target/$d to $SCALE_TO"
        $OC_BIN scale "$target/$d" --replicas="$SCALE_TO" -n "$ns"
      fi
    done
  done

  echo "âœ… Completed namespace: $ns"
  echo "-------------------------------------------"
done

echo ""
echo "ðŸŽ¯ All selected namespaces have been successfully scaled up to $SCALE_TO replicas."

# ====== STATUS CHECK SECTION ======
echo ""
echo "==========================================="
echo " Checking Deployment Status After Startup "
echo "==========================================="

for ns in "${NAMESPACES[@]}"; do
  echo ""
  echo ">>> Namespace: $ns"
  $OC_BIN get deploy -n "$ns" | awk 'NR==1 || /NAME|[1-9]/ {print}'
done

echo ""
echo "âœ… Status check completed for all namespaces."

# --- END DATE/TIME SECTION ---
END_TIME=$(date +"%Y-%m-%d %H:%M:%S")
echo "==========================================="
echo " Script finished on: $END_TIME"
echo "==========================================="
# -----------------------------
